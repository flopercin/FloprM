<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Platform</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #fullscreenBtn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #joystick {
            position: absolute;
            bottom: 100px;
            left: 80px;
            width: 80px;
            height: 80px;
            background: rgba(0,0,0,0.3);
            border-radius: 50%;
            display: none;
        }
        #joystickKnob {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            top: 20px;
            left: 20px;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    <button id="fullscreenBtn">Fullscreen</button>
    <div id="joystick"><div id="joystickKnob"></div></div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const fullscreenBtn = document.getElementById('fullscreenBtn');
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystickKnob');

        let isMobile = false;
        let joystickActive = false;
        let joystickX = 0;
        let joystickY = 0;
        let joystickStartX = 0;
        let joystickStartY = 0;
        let joystickKnobX = 0;
        let joystickKnobY = 0;

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const player = {
            x: 0,
            y: 1.6,
            z: 0,
            rotX: 0,
            rotY: 0,
            speed: 0.1
        };

        const platform = {
            size: 20,
            height: 0
        };

        const keys = {};
        const mouse = { x: 0, y: 0, prevX: 0, prevY: 0, isDown: false };

        function init() {
            window.addEventListener('resize', resize);
            document.addEventListener('keydown', keyDown);
            document.addEventListener('keyup', keyUp);
            canvas.addEventListener('mousedown', mouseDown);
            canvas.addEventListener('mouseup', mouseUp);
            canvas.addEventListener('mousemove', mouseMove);
            canvas.addEventListener('touchstart', handleTouch, { passive: false });
            canvas.addEventListener('touchmove', handleTouch, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            if ('ontouchstart' in window) {
                isMobile = true;
                joystick.style.display = 'block';
            }

            resize();
            loop();
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function keyDown(e) {
            keys[e.key.toLowerCase()] = true;
        }

        function keyUp(e) {
            keys[e.key.toLowerCase()] = false;
        }

        function mouseDown(e) {
            mouse.isDown = true;
            mouse.prevX = e.clientX;
            mouse.prevY = e.clientY;
        }

        function mouseUp() {
            mouse.isDown = false;
        }

        function mouseMove(e) {
            if (mouse.isDown) {
                const dx = e.clientX - mouse.prevX;
                const dy = e.clientY - mouse.prevY;
                player.rotY -= dx * 0.002;
                player.rotX -= dy * 0.002;
                player.rotX = Math.max(-Math.PI/2, Math.min(Math.PI/2, player.rotX));
                mouse.prevX = e.clientX;
                mouse.prevY = e.clientY;
            }
        }

        function handleTouch(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;

                if (touchX < canvas.width * 0.5) {
                    joystickActive = true;
                    joystickStartX = joystick.offsetLeft + joystick.offsetWidth / 2;
                    joystickStartY = joystick.offsetTop + joystick.offsetHeight / 2;
                    joystickX = touchX;
                    joystickY = touchY;
                    updateJoystick();
                } else {
                    mouse.isDown = true;
                    mouse.prevX = touchX;
                    mouse.prevY = touchY;
                }
            }
        }

        function handleTouchEnd() {
            joystickActive = false;
            joystickKnob.style.transform = 'translate(20px, 20px)';
            mouse.isDown = false;
        }

        function updateJoystick() {
            if (!joystickActive) return;

            const dx = joystickX - joystickStartX;
            const dy = joystickY - joystickStartY;
            const distance = Math.min(30, Math.sqrt(dx*dx + dy*dy));
            const angle = Math.atan2(dy, dx);

            joystickKnobX = Math.cos(angle) * distance;
            joystickKnobY = Math.sin(angle) * distance;
            joystickKnob.style.transform = `translate(${joystickKnobX + 20}px, ${joystickKnobY + 20}px)`;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                canvas.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        }

        function movePlayer() {
            let moveX = 0;
            let moveZ = 0;

            if (joystickActive) {
                moveX = joystickKnobX / 30;
                moveZ = joystickKnobY / 30;
            } else {
                if (keys['w'] || keys['ц']) moveZ = -1;
                if (keys['s'] || keys['ы']) moveZ = 1;
                if (keys['a'] || keys['ф']) moveX = -1;
                if (keys['d'] || keys['в']) moveX = 1;
            }

            const speed = player.speed;
            const sinY = Math.sin(player.rotY);
            const cosY = Math.cos(player.rotY);

            player.x += (moveZ * sinY + moveX * cosY) * speed;
            player.z += (moveZ * cosY - moveX * sinY) * speed;

            const halfSize = platform.size / 2;
            player.x = Math.max(-halfSize, Math.min(halfSize, player.x));
            player.z = Math.max(-halfSize, Math.min(halfSize, player.z));
        }

        function drawScene() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const horizon = canvas.height / 2;
            const scale = canvas.height / 2;

            ctx.fillStyle = '#87CEEB';
            ctx.fillRect(0, 0, canvas.width, horizon);

            ctx.fillStyle = '#228B22';
            ctx.fillRect(0, horizon, canvas.width, canvas.height - horizon);

            const gridSize = platform.size;
            const gridStep = 1;
            const gridColor = '#555';

            for (let x = -gridSize; x <= gridSize; x += gridStep) {
                drawLine(x, 0, -gridSize, x, 0, gridSize, gridColor);
            }

            for (let z = -gridSize; z <= gridSize; z += gridStep) {
                drawLine(-gridSize, 0, z, gridSize, 0, z, gridColor);
            }
        }

        function drawLine(x1, y1, z1, x2, y2, z2, color) {
            const p1 = projectPoint(x1 - player.x, y1 - player.y, z1 - player.z);
            const p2 = projectPoint(x2 - player.x, y2 - player.y, z2 - player.z);

            if (p1.z > 0 && p2.z > 0) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(p1.x, p1.y);
                ctx.lineTo(p2.x, p2.y);
                ctx.stroke();
            }
        }

        function projectPoint(x, y, z) {
            const cosX = Math.cos(player.rotX);
            const sinX = Math.sin(player.rotX);
            const cosY = Math.cos(player.rotY);
            const sinY = Math.sin(player.rotY);

            const rotYx = x * cosY - z * sinY;
            const rotYz = x * sinY + z * cosY;

            const rotXy = y * cosX - rotYz * sinX;
            const rotXz = y * sinX + rotYz * cosX;

            const scale = canvas.height / 2;
            const projectedX = rotYx / rotXz * scale + canvas.width / 2;
            const projectedY = -rotXy / rotXz * scale + canvas.height / 2;

            return { x: projectedX, y: projectedY, z: rotXz };
        }

        function loop() {
            movePlayer();
            drawScene();
            requestAnimationFrame(loop);
        }

        init();
    </script>
</body>
</html>